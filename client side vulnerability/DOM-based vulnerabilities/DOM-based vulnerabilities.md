## What is DOM ?
DOM (Document Object Model) là cấu trúc phân cấp của trang web mà trình duyệt xây dựng, thể hiện dưới dạng cây các nút (nodes) và đối tượng (objects) tương ứng với các thẻ HTML, thuộc tính và nội dung
## Taint Flow
### Source
``` Common_source
document.URL 
document.documentURI 
document.URLUnencoded 
document.baseURI 
location 
document.cookie 
document.referrer 
window.name 
history.pushState 
history.replaceState 
localStorage 
sessionStorage 
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB) 
Database
```
### Sink
```
DOM XSS document.write()  
Open redirection  window.location  
Cookie manipulation  document.cookie  
JavaScript injection eval()  
Document-domain manipulation document.domain  
WebSocket-URL poisoning WebSocket()  
Link manipulation element.src  
Web message manipulation postMessage()  
Ajax request-header manipulation setRequestHeader()  
Local file-path manipulation FileReader.readAsText()  
Client-side SQL injection ExecuteSql()  
HTML5-storage manipulation sessionStorage.setItem()  
Client-side XPath injection document.evaluate()  
Client-side JSON injection JSON.parse()  
DOM-data manipulation element.setAttribute()  
Denial of service RegExp()
```

## DOM clobbering
#TODO: Update later
[An Art of Dom Clobbering - From Zero to Advance Level - HACKLIDO](https://hacklido.com/blog/43-an-art-of-dom-clobbering-from-zero-to-advance-level)
[DOM Clobbering](https://domclob.xyz/domc_markups/list)
## DOM-based vulnerabilities
###  DOM-based open redirection
**[URL validation bypass cheat sheet](https://portswigger.net/web-security/ssrf/url-validation-bypass-cheat-sheet)**
Một số sink trong trường hợp này
``` SINK
location 
location.host 
location.hostname 
location.href 
location.pathname 
location.search 
location.protocol 
location.assign() 
location.replace() 
open() 
element.srcdoc 
XMLHttpRequest.open() 
XMLHttpRequest.send() 
jQuery.ajax() 
$.ajax()
```

### Cookie manipulation
Một số trang web cho phép JavaScript **ghi dữ liệu từ nguồn không đáng tin** (như `location.hash`) vào `document.cookie`. Điều này có thể **bị kẻ tấn công lợi dụng để ép người dùng lưu cookie tùy ý**, mà sau đó có thể được trang web sử dụng **một cách không an toàn**, dẫn đến **XSS**, **session fixation**, hoặc (exploit chain)**.
###### 🧨 Trường hợp 1: Cookie điều khiển hành vi trên website
Ví dụ:
- Cookie có tên `mode=demo` hoặc `mode=prod`
- Dựa vào cookie này, trang web hiển thị nội dung khác nhau
→ Khi attacker có thể ép nạn nhân lưu cookie tùy ý, họ có thể **thay đổi hành vi của trang**, khiến người dùng:
- truy cập sai chức năng,
- bypass được giới hạn UI,
- bị lừa thực hiện hành động không mong muốn (UX manipulation)
##### 🧨 Trường hợp 2: Cookie chứa **token phiên (session ID)**
- Website dùng cookie như `sessionId=xyz123` để xác thực người dùng
- Nếu attacker ép nạn nhân dùng session ID do hắn cấp → gọi là **Session Fixation**
**Mục tiêu**: Chiếm quyền truy cập sau khi người dùng đăng nhập
**Quy trình session fixation:**
1. Attacker có sẵn token hợp lệ: `sessionId=attackerToken`
2. Gửi link dạng:
	`https://victim.com/page#sessionId=attackerToken`
3. Trang có JS như:
    `document.cookie = 'sessionId=' + location.hash.slice(1);`
4. Người dùng bị ép dùng session ID của attacker
5. Khi user đăng nhập → session thuộc attacker
### JavaScript injection
**sink** thường dẫn đến DOM-based JavaScript Injection
```
- eval()
- Function() (hàm khởi tạo Function động)
- setTimeout()
- setInterval()
- setImmediate() / msSetImmediate() (trình duyệt cũ của Microsoft)
- execCommand()
- execScript()
- Range.createContextualFragment()
- crypto.generateCRMFRequest()
```
### Document-domain manipulation
- Đây là một **kiểu lỗ hổng DOM-based** xảy ra khi code trên client-side cho phép attacker điều khiển việc gán giá trị cho **`document.domain`**.
- `document.domain` là thuộc tính mà trình duyệt dùng để **nới lỏng Same-Origin Policy (SOP)**.    
- Nếu hai trang khác origin nhưng cùng gán `document.domain` thành một giá trị chung → chúng có thể truy cập DOM, cookie, và JS của nhau.
Sau khi thử nghiệm thì vấn đề là ở subdomain thì mới chỉnh lên domain. 

> *Đây là lỗ hổng DOM-based hiếm gặp nhưng impact gần ngang **XSS** vì có thể dẫn đến **full DOM access**. Sink chính là `document.domain`. Phòng tránh bằng cách **tuyệt đối không để user input điều khiển `document.domain`**.*

### WebSocket-URL poisoning
**DOM-based WebSocket-URL poisoning** xảy ra khi ứng dụng phía client sử dụng dữ liệu do người dùng kiểm soát để làm URL cho kết nối WebSocket. Kẻ tấn công có thể lợi dụng điểm yếu này để ép trình duyệt của nạn nhân mở kết nối WebSocket tới server do chúng kiểm soát, từ đó đánh cắp dữ liệu hoặc chèn nội dung độc hại.

### Link manipulation
#### DOM-based link manipulation là gì?
Lỗ hổng DOM-based link manipulation xảy ra khi ứng dụng ghi dữ liệu có thể bị attacker kiểm soát vào các thuộc tính điều hướng trên trang, chẳng hạn như đích của thẻ link hoặc URL submit của form. Attacker có thể tạo một URL đặc biệt để khi người dùng truy cập, các liên kết trên trang sẽ bị thay đổi theo ý chúng.
#### Tác động
- Redirect tùy ý: đưa người dùng tới trang độc hại → phục vụ phishing.
- Form hijacking: làm form gửi dữ liệu nhạy cảm sang server của attacker.
- Thay đổi link/action: ép người dùng thực hiện hành động trái ý muốn.
- Bypass cơ chế anti-XSS: chèn link nội bộ chứa payload XSS (do anti-XSS thường bỏ qua link on-site).

**Sink**
``` js
element.href
element.src
element.action
```

### DOM-based Web Message Manipulation
#### Định nghĩa

- **DOM-based web message manipulation** là một lỗ hổng xuất hiện khi ứng dụng sử dụng dữ liệu có thể bị kiểm soát bởi attacker để truyền qua **cơ chế web messaging** (ví dụ `window.postMessage`).
    
- Lỗ hổng này cho phép kẻ tấn công tiêm dữ liệu tùy ý vào thông điệp, từ đó thay đổi hành vi hoặc khai thác ứng dụng ở phía nhận message.

#### Cơ chế
1. Script trong trang A lấy dữ liệu từ một nguồn không tin cậy (URL fragment, query string, local storage…).
    
2. Script này truyền trực tiếp dữ liệu đó qua `window.postMessage()` sang trang B.
    
3. Trang B có listener (`window.addEventListener("message", ...)`) nhưng **không xác thực nguồn gốc (`event.origin`)** hoặc **xử lý dữ liệu một cách không an toàn**.
    
4. Kẻ tấn công có thể lợi dụng để:
    - Điều khiển nội dung message.
    - Tạo message giả từ một trang độc hại.

#### Tác động tiềm ẩn
- **Data exfiltration**: ép ứng dụng gửi thông tin nhạy cảm sang domain do attacker kiểm soát.
    
- **Logic manipulation**: giả mạo dữ liệu hợp lệ để thay đổi luồng xử lý ứng dụng.
    
- **Client-side injection**: nếu dữ liệu message được render trực tiếp, có thể dẫn đến DOM XSS.
#### Sink nguy hiểm
- **`window.postMessage()`** (sink chính).

#### More ... #TODO