## What is DOM ?
DOM (Document Object Model) lÃ  cáº¥u trÃºc phÃ¢n cáº¥p cá»§a trang web mÃ  trÃ¬nh duyá»‡t xÃ¢y dá»±ng, thá»ƒ hiá»‡n dÆ°á»›i dáº¡ng cÃ¢y cÃ¡c nÃºt (nodes) vÃ  Ä‘á»‘i tÆ°á»£ng (objects) tÆ°Æ¡ng á»©ng vá»›i cÃ¡c tháº» HTML, thuá»™c tÃ­nh vÃ  ná»™i dung
## Taint Flow
### Source
``` Common_source
document.URL 
document.documentURI 
document.URLUnencoded 
document.baseURI 
location 
document.cookie 
document.referrer 
window.name 
history.pushState 
history.replaceState 
localStorage 
sessionStorage 
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB) 
Database
```
### Sink
```
DOM XSS document.write()  
Open redirection  window.location  
Cookie manipulation  document.cookie  
JavaScript injection eval()  
Document-domain manipulation document.domain  
WebSocket-URL poisoning WebSocket()  
Link manipulation element.src  
Web message manipulation postMessage()  
Ajax request-header manipulation setRequestHeader()  
Local file-path manipulation FileReader.readAsText()  
Client-side SQL injection ExecuteSql()  
HTML5-storage manipulation sessionStorage.setItem()  
Client-side XPath injection document.evaluate()  
Client-side JSON injection JSON.parse()  
DOM-data manipulation element.setAttribute()  
Denial of service RegExp()
```

## DOM clobbering
#TODO: Update later
[An Art of Dom Clobbering - From Zero to Advance Level - HACKLIDO](https://hacklido.com/blog/43-an-art-of-dom-clobbering-from-zero-to-advance-level)
[DOM Clobbering](https://domclob.xyz/domc_markups/list)
## DOM-based vulnerabilities
###  DOM-based open redirection
**[URL validation bypass cheat sheet](https://portswigger.net/web-security/ssrf/url-validation-bypass-cheat-sheet)**
Má»™t sá»‘ sink trong trÆ°á»ng há»£p nÃ y
``` SINK
location 
location.host 
location.hostname 
location.href 
location.pathname 
location.search 
location.protocol 
location.assign() 
location.replace() 
open() 
element.srcdoc 
XMLHttpRequest.open() 
XMLHttpRequest.send() 
jQuery.ajax() 
$.ajax()
```

### Cookie manipulation
Má»™t sá»‘ trang web cho phÃ©p JavaScript **ghi dá»¯ liá»‡u tá»« nguá»“n khÃ´ng Ä‘Ã¡ng tin** (nhÆ° `location.hash`) vÃ o `document.cookie`. Äiá»u nÃ y cÃ³ thá»ƒ **bá»‹ káº» táº¥n cÃ´ng lá»£i dá»¥ng Ä‘á»ƒ Ã©p ngÆ°á»i dÃ¹ng lÆ°u cookie tÃ¹y Ã½**, mÃ  sau Ä‘Ã³ cÃ³ thá»ƒ Ä‘Æ°á»£c trang web sá»­ dá»¥ng **má»™t cÃ¡ch khÃ´ng an toÃ n**, dáº«n Ä‘áº¿n **XSS**, **session fixation**, hoáº·c (exploit chain)**.
###### ğŸ§¨ TrÆ°á»ng há»£p 1: Cookie Ä‘iá»u khiá»ƒn hÃ nh vi trÃªn website
VÃ­ dá»¥:
- Cookie cÃ³ tÃªn `mode=demo` hoáº·c `mode=prod`
- Dá»±a vÃ o cookie nÃ y, trang web hiá»ƒn thá»‹ ná»™i dung khÃ¡c nhau
â†’ Khi attacker cÃ³ thá»ƒ Ã©p náº¡n nhÃ¢n lÆ°u cookie tÃ¹y Ã½, há» cÃ³ thá»ƒ **thay Ä‘á»•i hÃ nh vi cá»§a trang**, khiáº¿n ngÆ°á»i dÃ¹ng:
- truy cáº­p sai chá»©c nÄƒng,
- bypass Ä‘Æ°á»£c giá»›i háº¡n UI,
- bá»‹ lá»«a thá»±c hiá»‡n hÃ nh Ä‘á»™ng khÃ´ng mong muá»‘n (UX manipulation)
##### ğŸ§¨ TrÆ°á»ng há»£p 2: Cookie chá»©a **token phiÃªn (session ID)**
- Website dÃ¹ng cookie nhÆ° `sessionId=xyz123` Ä‘á»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng
- Náº¿u attacker Ã©p náº¡n nhÃ¢n dÃ¹ng session ID do háº¯n cáº¥p â†’ gá»i lÃ  **Session Fixation**
**Má»¥c tiÃªu**: Chiáº¿m quyá»n truy cáº­p sau khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p
**Quy trÃ¬nh session fixation:**
1. Attacker cÃ³ sáºµn token há»£p lá»‡: `sessionId=attackerToken`
2. Gá»­i link dáº¡ng:
	`https://victim.com/page#sessionId=attackerToken`
3. Trang cÃ³ JS nhÆ°:
    `document.cookie = 'sessionId=' + location.hash.slice(1);`
4. NgÆ°á»i dÃ¹ng bá»‹ Ã©p dÃ¹ng session ID cá»§a attacker
5. Khi user Ä‘Äƒng nháº­p â†’ session thuá»™c attacker
### JavaScript injection
**sink** thÆ°á»ng dáº«n Ä‘áº¿n DOM-based JavaScript Injection
```
- eval()
- Function() (hÃ m khá»Ÿi táº¡o Function Ä‘á»™ng)
- setTimeout()
- setInterval()
- setImmediate() / msSetImmediate() (trÃ¬nh duyá»‡t cÅ© cá»§a Microsoft)
- execCommand()
- execScript()
- Range.createContextualFragment()
- crypto.generateCRMFRequest()
```
### Document-domain manipulation
- ÄÃ¢y lÃ  má»™t **kiá»ƒu lá»— há»•ng DOM-based** xáº£y ra khi code trÃªn client-side cho phÃ©p attacker Ä‘iá»u khiá»ƒn viá»‡c gÃ¡n giÃ¡ trá»‹ cho **`document.domain`**.
- `document.domain` lÃ  thuá»™c tÃ­nh mÃ  trÃ¬nh duyá»‡t dÃ¹ng Ä‘á»ƒ **ná»›i lá»ng Same-Origin Policy (SOP)**.    
- Náº¿u hai trang khÃ¡c origin nhÆ°ng cÃ¹ng gÃ¡n `document.domain` thÃ nh má»™t giÃ¡ trá»‹ chung â†’ chÃºng cÃ³ thá»ƒ truy cáº­p DOM, cookie, vÃ  JS cá»§a nhau.
Sau khi thá»­ nghiá»‡m thÃ¬ váº¥n Ä‘á» lÃ  á»Ÿ subdomain thÃ¬ má»›i chá»‰nh lÃªn domain. 

> *ÄÃ¢y lÃ  lá»— há»•ng DOM-based hiáº¿m gáº·p nhÆ°ng impact gáº§n ngang **XSS** vÃ¬ cÃ³ thá»ƒ dáº«n Ä‘áº¿n **full DOM access**. Sink chÃ­nh lÃ  `document.domain`. PhÃ²ng trÃ¡nh báº±ng cÃ¡ch **tuyá»‡t Ä‘á»‘i khÃ´ng Ä‘á»ƒ user input Ä‘iá»u khiá»ƒn `document.domain`**.*

### WebSocket-URL poisoning
**DOM-based WebSocket-URL poisoning** xáº£y ra khi á»©ng dá»¥ng phÃ­a client sá»­ dá»¥ng dá»¯ liá»‡u do ngÆ°á»i dÃ¹ng kiá»ƒm soÃ¡t Ä‘á»ƒ lÃ m URL cho káº¿t ná»‘i WebSocket. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘iá»ƒm yáº¿u nÃ y Ä‘á»ƒ Ã©p trÃ¬nh duyá»‡t cá»§a náº¡n nhÃ¢n má»Ÿ káº¿t ná»‘i WebSocket tá»›i server do chÃºng kiá»ƒm soÃ¡t, tá»« Ä‘Ã³ Ä‘Ã¡nh cáº¯p dá»¯ liá»‡u hoáº·c chÃ¨n ná»™i dung Ä‘á»™c háº¡i.

### Link manipulation
#### DOM-based link manipulation lÃ  gÃ¬?
Lá»— há»•ng DOM-based link manipulation xáº£y ra khi á»©ng dá»¥ng ghi dá»¯ liá»‡u cÃ³ thá»ƒ bá»‹ attacker kiá»ƒm soÃ¡t vÃ o cÃ¡c thuá»™c tÃ­nh Ä‘iá»u hÆ°á»›ng trÃªn trang, cháº³ng háº¡n nhÆ° Ä‘Ã­ch cá»§a tháº» link hoáº·c URL submit cá»§a form. Attacker cÃ³ thá»ƒ táº¡o má»™t URL Ä‘áº·c biá»‡t Ä‘á»ƒ khi ngÆ°á»i dÃ¹ng truy cáº­p, cÃ¡c liÃªn káº¿t trÃªn trang sáº½ bá»‹ thay Ä‘á»•i theo Ã½ chÃºng.
#### TÃ¡c Ä‘á»™ng
- Redirect tÃ¹y Ã½: Ä‘Æ°a ngÆ°á»i dÃ¹ng tá»›i trang Ä‘á»™c háº¡i â†’ phá»¥c vá»¥ phishing.
- Form hijacking: lÃ m form gá»­i dá»¯ liá»‡u nháº¡y cáº£m sang server cá»§a attacker.
- Thay Ä‘á»•i link/action: Ã©p ngÆ°á»i dÃ¹ng thá»±c hiá»‡n hÃ nh Ä‘á»™ng trÃ¡i Ã½ muá»‘n.
- Bypass cÆ¡ cháº¿ anti-XSS: chÃ¨n link ná»™i bá»™ chá»©a payload XSS (do anti-XSS thÆ°á»ng bá» qua link on-site).

**Sink**
``` js
element.href
element.src
element.action
```

### DOM-based Web Message Manipulation
#### Äá»‹nh nghÄ©a

- **DOM-based web message manipulation** lÃ  má»™t lá»— há»•ng xuáº¥t hiá»‡n khi á»©ng dá»¥ng sá»­ dá»¥ng dá»¯ liá»‡u cÃ³ thá»ƒ bá»‹ kiá»ƒm soÃ¡t bá»Ÿi attacker Ä‘á»ƒ truyá»n qua **cÆ¡ cháº¿ web messaging** (vÃ­ dá»¥ `window.postMessage`).
    
- Lá»— há»•ng nÃ y cho phÃ©p káº» táº¥n cÃ´ng tiÃªm dá»¯ liá»‡u tÃ¹y Ã½ vÃ o thÃ´ng Ä‘iá»‡p, tá»« Ä‘Ã³ thay Ä‘á»•i hÃ nh vi hoáº·c khai thÃ¡c á»©ng dá»¥ng á»Ÿ phÃ­a nháº­n message.

#### CÆ¡ cháº¿
1. Script trong trang A láº¥y dá»¯ liá»‡u tá»« má»™t nguá»“n khÃ´ng tin cáº­y (URL fragment, query string, local storageâ€¦).
    
2. Script nÃ y truyá»n trá»±c tiáº¿p dá»¯ liá»‡u Ä‘Ã³ qua `window.postMessage()` sang trang B.
    
3. Trang B cÃ³ listener (`window.addEventListener("message", ...)`) nhÆ°ng **khÃ´ng xÃ¡c thá»±c nguá»“n gá»‘c (`event.origin`)** hoáº·c **xá»­ lÃ½ dá»¯ liá»‡u má»™t cÃ¡ch khÃ´ng an toÃ n**.
    
4. Káº» táº¥n cÃ´ng cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘á»ƒ:
    - Äiá»u khiá»ƒn ná»™i dung message.
    - Táº¡o message giáº£ tá»« má»™t trang Ä‘á»™c háº¡i.

#### TÃ¡c Ä‘á»™ng tiá»m áº©n
- **Data exfiltration**: Ã©p á»©ng dá»¥ng gá»­i thÃ´ng tin nháº¡y cáº£m sang domain do attacker kiá»ƒm soÃ¡t.
    
- **Logic manipulation**: giáº£ máº¡o dá»¯ liá»‡u há»£p lá»‡ Ä‘á»ƒ thay Ä‘á»•i luá»“ng xá»­ lÃ½ á»©ng dá»¥ng.
    
- **Client-side injection**: náº¿u dá»¯ liá»‡u message Ä‘Æ°á»£c render trá»±c tiáº¿p, cÃ³ thá»ƒ dáº«n Ä‘áº¿n DOM XSS.
#### Sink nguy hiá»ƒm
- **`window.postMessage()`** (sink chÃ­nh).

#### More ... #TODO